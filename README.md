# –ü–∞—Ä—Å–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º—ã –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–ü–ª—é—Å

–ü—Ä–æ–µ–∫—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π —Å–∏—Å—Ç–µ–º—ã –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–ü–ª—é—Å

## üìå –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

[![–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](https://docs.google.com/drawings/d/e/2PACX-1vRxt3x7fbQ7phT_3z8eUpc5nJW_NbU5yCgOsPuT7kAOCSWxXyZ7oKKLic5spuktzNir2fjPjQ-ZrP73/pub?w=901&h=720)](
https://docs.google.com/drawings/d/e/2PACX-1vRxt3x7fbQ7phT_3z8eUpc5nJW_NbU5yCgOsPuT7kAOCSWxXyZ7oKKLic5spuktzNir2fjPjQ-ZrP73/pub?w=901&h=720)

```
===================================================================================================================

                                      +---------------------------+
                                      |           Main            |
                                      +---------------------------+
                                      | - initLogger              |
                                      | - initSparkSession        |
                                      | - processRawData          |
                                      | - task1 (–ø–æ–∏—Å–∫ –ø–æ docId)  |
                                      | - task2 (–∞–≥—Ä–µ–≥–∞—Ü–∏—è docs)  |
                                      | - printResults            |
                                      +---------------------------+
                                                ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚ñº                                                                                         ‚ñº
+------------------------------------+                                        +--------------------------------+
|  SparkSession                      |                                        |  log4j2 logger (log4j2.xml)   |
|  + wholeTextFiles(inputPath)       |                                        |  + ParseError                 |
|  + errorAccumulator                |                                        |  + logs/errors.log            |
+------------------------------------+                                        +--------------------------------+
        ‚îÇ
        ‚ñº
+---------------------------------------------------------+
|             SessionParser (per file)                    |
|---------------------------------------------------------|
| .parse(content, filePath, errorAcc)                     |
|  ‚îú‚îÄ "SESSION_START <date>"  ‚Üí parseStart()              |
|  ‚îú‚îÄ "SESSION_END <date>"    ‚Üí parseEnd()                |
|  ‚îú‚îÄ "QS {...}"              ‚Üí QuickSearch.parse         |
|  ‚îú‚îÄ "CARD_SEARCH_START..."  ‚Üí CardSearch.parse          |
|  ‚îú‚îÄ "DOC_OPEN..."           ‚Üí DocOpen.parse             |
|  ‚îî‚îÄ Accumulates errors      ‚Üí errorAccumulator, logs    |
+------------------‚î¨--------------------------------------+
                   ‚ñº
+---------------------------------------------------------+
|             SessionBuilder                              |
|---------------------------------------------------------|
|  Fields:                                                |
|    - startDate: DateTime                                |
|    - endDate: DateTime                                  |
|    - quickSearches: List[QuickSearch] (mutable)         |
|    - cardSearches:  List[CardSearch] (mutable)          |
|    - docOpens:      List[DocOpen] (mutable)             |
|                                                         |
|  –ú–µ—Ç–æ–¥—ã:                                                |
|    - build(): Session                                   |
|    - buildWithRecoveredIds(): Session (—á–µ—Ä–µ–∑ RecoverID) |
+------------------‚î¨--------------------------------------+
                   ‚ñº
+---------------------------------------------------------+
|             RecoverID                                   |
|---------------------------------------------------------|
| Step 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ docOpen.id                       |
|   - –µ—Å–ª–∏ docId –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º QS/CS         |
| Step 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ id —É QuickSearch –∏ CardSearch    |
|   - –µ—Å–ª–∏ –µ—Å—Ç—å docOpen —Å —ç—Ç–∏–º docId –∏ –Ω–µ–Ω—É–ª–µ–≤—ã–º id       |
| - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤                       |
+------------------‚î¨--------------------------------------+
                   ‚ñº
+---------------------------------------------------------+
|                    Session                              |
|---------------------------------------------------------|
| - startDate: DateTime                                   |
| - endDate: DateTime                                     |
| - quickSearches: List[QuickSearch]                      |
| - cardSearches: List[CardSearch]                        |
| - docOpens: List[DocOpen]                               |
+---------------------------------------------------------+

–°—É—â–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏–π (Events)
===================================================================================================================

QuickSearch:
------------
| –ü–æ–ª—è: date, id, query, docIds         |
| –ú–µ—Ç–æ–¥—ã:                               |
|  - parse(lines, file, acc, date)      |
|  - extract(content, sessionDate)      |
| –ó–∞–≤–∏—Å–∏—Ç –æ—Ç: DateTime, ParseError, logger

CardSearch:
-----------
| –ü–æ–ª—è: date, id, query, docIds         |
| –ú–µ—Ç–æ–¥—ã:                               |
|  - parse(lines, file, acc, date)      |
|  - extract(lines, sessionDate)        |
| –ó–∞–≤–∏—Å–∏—Ç –æ—Ç: DateTime, ParseError, logger

DocOpen:
--------
| –ü–æ–ª—è: date, id, docId                 |
| –ú–µ—Ç–æ–¥—ã:                               |
|  - parse(lines, file, acc, date)      |
|  - extract(line, sessionDate)         |
| –ó–∞–≤–∏—Å–∏—Ç –æ—Ç: DateTime, ParseError, logger

DateTime:
---------
| parse(str)                            |
| toString()                            |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤:                   |
|  - "dd.MM.yyyy_HH:mm:ss"              |
|  - "EEE,_dd_MMM_yyyy_HH:mm:ss_+ZZZZ"  |

–¢–µ—Å—Ç—ã
===================================================================================================================

‚Ä¢ QuickSearchTest
  - –≤–∞–ª–∏–¥–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥, —Å–ø–µ—Ü. —Å–∏–º–≤–æ–ª—ã, –ø—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
  - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

‚Ä¢ CardSearchTest
  - –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–ª–æ–∫, –ø–∞–¥–µ–Ω–∏–µ –ø–æ –¥–∞—Ç–µ, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

‚Ä¢ DocOpenTest
  - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ID, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ID, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥

‚Ä¢ RecoverIDTest
  - ID docOpen ‚Üê QS/CS
  - QS/CS ‚Üê docOpen
  - –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏

‚Ä¢ DateTimeTest
  - –ø–∞—Ä—Å–∏–Ω–≥, –æ—à–∏–±–∫–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–¥–∞—á–∏ (Main)
===================================================================================================================

‚Ä¢ task1(docId: String): Long
  - –ò—â–µ—Ç –≤—Ö–æ–∂–¥–µ–Ω–∏–µ docId –≤ CardSearch.query
  - –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ –∏ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏ –±—É–∫–≤ (—Ä–µ–≥—É–ª—è—Ä–∫–∞)

‚Ä¢ task2(): Seq[(String, String, Int)]
  - –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–∞–∂–¥—ã–π docId –∏–∑ QS —Ä–µ–∞–ª—å–Ω–æ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç


–í—ã–≤–æ–¥
===================================================================================================================
‚Ä¢ –ö–æ–Ω—Å–æ–ª—å:
  - –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª—Å—è –ø–æ–∏—Å–∫ ACC_45616 —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç–æ—á–∫—É 
  - –¢–æ–ø-5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ CSV:
  - –§–æ—Ä–º–∞—Ç: `date,docId,count` ‚Üí `output/task2.csv`
```

## üìä –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

```
Document ACC_45616 was searched in cards 24 times

Date,DocID,Count

------------------
05.03.2020,ACC_45615,14
16.03.2020,ACC_45616,14
21.04.2020,ACC_45615,13
23.09.2020,ACC_45614,12
13.03.2020,ACC_45616,12
```

- **–ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª–∏ –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º ACC_45616**:
    - –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: **24**


- **–ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –¥–Ω—è–º**:
    - –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ñ–∞–π–ª–µ `task2.csv`

